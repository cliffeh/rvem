* extract emulator code out of main and into a library
